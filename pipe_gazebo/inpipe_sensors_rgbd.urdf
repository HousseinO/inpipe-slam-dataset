<?xml version="1.0"?>
<robot name="inpipe_sensors">

  <!-- ============ Base ============ -->
  <link name="base_link">
    <visual>
      <geometry>
        <cylinder radius="0.07" length="0.05"/>
      </geometry>
      <material name="gray">
        <color rgba="0.5 0.5 0.5 1"/>
      </material>
    </visual>
    <collision>
      <geometry>
        <cylinder radius="0.07" length="0.05"/>
      </geometry>
    </collision>
    <inertial>
      <mass value="0.5"/>
      <inertia ixx="0.001" iyy="0.001" izz="0.001" ixy="0" ixz="0" iyz="0"/>
    </inertial>
  </link>


<!-- LEFT sonar -->
<link name="sonar_left_link">
  <visual>
    <origin xyz="0 0 0" rpy="0 0 0"/>
    <geometry><cylinder radius="0.01" length="0.02"/></geometry>
    <material name="black"><color rgba="0.1 0.1 0.1 1"/></material>
  </visual>
  <collision>
    <geometry><cylinder radius="0.01" length="0.02"/></geometry>
  </collision>
  <inertial>
    <mass value="0.02"/>
    <inertia ixx="1e-5" iyy="1e-5" izz="1e-5" ixy="0" ixz="0" iyz="0"/>
  </inertial>
</link>

<joint name="camera_to_sonar_left" type="fixed">
  <!-- ~6 cm to the left of the camera -->
  <origin xyz="0 0.06 0" rpy="0 0 0"/>
  <parent link="camera_link"/>
  <child  link="sonar_left_link"/>
</joint>

<!-- RIGHT sonar -->
<link name="sonar_right_link">
  <visual>
    <origin xyz="0 0 0" rpy="0 0 0"/>
    <geometry><cylinder radius="0.01" length="0.02"/></geometry>
    <material name="black"><color rgba="0.1 0.1 0.1 1"/></material>
  </visual>
  <collision>
    <geometry><cylinder radius="0.01" length="0.02"/></geometry>
  </collision>
  <inertial>
    <mass value="0.02"/>
    <inertia ixx="1e-5" iyy="1e-5" izz="1e-5" ixy="0" ixz="0" iyz="0"/>
  </inertial>
</link>

<joint name="camera_to_sonar_right" type="fixed">
  <!-- ~6 cm to the right of the camera -->
  <origin xyz="0 -0.06 0" rpy="0 0 0"/>
  <parent link="camera_link"/>
  <child  link="sonar_right_link"/>
</joint>

  <!-- ============ Camera ============ -->
<link name="realsense_link">
  <visual>
    <geometry><box size="0.09 0.025 0.025"/></geometry>
    <material name="black"><color rgba="0.1 0.1 0.1 1"/></material>
  </visual>
  <collision>
    <geometry><box size="0.09 0.025 0.025"/></geometry>
  </collision>
  <inertial>
    <mass value="0.09"/>
    <inertia ixx="0.0002" iyy="0.0002" izz="0.0002" ixy="0" ixz="0" iyz="0"/>
  </inertial>
</link>

<!-- Mount it where your old camera was: (0.1, 0, 0.05) -->
<joint name="base_to_realsense" type="fixed">
  <origin xyz="0.1 0 0.05" rpy="0 0 0"/>
  <parent link="base_link"/>
  <child link="realsense_link"/>
</joint>

  <!-- ============ Lidar ============ -->
  <link name="lidar_link">
    <!-- Visual so it shows up in Gazebo -->
    <visual>
      <geometry>
        <cylinder radius="0.03" length="0.02"/>
      </geometry>
      <material name="blue">
        <color rgba="0.2 0.2 0.8 1.0"/>
      </material>
    </visual>
    <collision>
      <geometry>
        <cylinder radius="0.03" length="0.02"/>
      </geometry>
    </collision>
    <inertial>
      <mass value="0.03"/>
      <inertia ixx="0.00005" iyy="0.00005" izz="0.00005" ixy="0" ixz="0" iyz="0"/>
    </inertial>
  </link>

  <joint name="base_to_lidar" type="fixed">
    <!-- Pose of lidar_link relative to base_link -->
    <origin xyz="0.0 0 0.08" rpy="0 0 0"/>
    <parent link="base_link"/>
    <child link="lidar_link"/>
  </joint>

  <!-- ============ Camera sensor (ROS 2 Gazebo Classic) ============ -->
  <!-- Gazebo sensors on the realsense_link -->
<gazebo reference="realsense_link">
  <!-- Depth stream -->
  <sensor name="cameradepth" type="depth">
    <always_on>true</always_on>
    <update_rate>30</update_rate>
    <visualize>false</visualize>
    <camera name="camera">
      <horizontal_fov>1.57</horizontal_fov>
      <image><width>1280</width><height>720</height></image>
      <clip><near>0.1</near><far>100</far></clip>
      <noise>
            <type>gaussian</type>
            <mean>0.0</mean>
            <stddev>0.100</stddev>
          </noise>
    </camera>
  </sensor>

  <!-- RGB stream -->
  <sensor name="cameracolor" type="camera">
    <always_on>true</always_on>
    <update_rate>30</update_rate>
    <visualize>true</visualize>
    <camera name="camera">
      <horizontal_fov>1.57</horizontal_fov>
      <image><width>1280</width><height>720</height><format>RGB_INT8</format></image>
      <clip><near>0.1</near><far>100</far></clip>
       <noise>
            <type>gaussian</type>
            <mean>0.0</mean>
            <stddev>0.007</stddev>
          </noise>
    </camera>
  </sensor>

  <!-- Infrared 1 -->
  <sensor name="cameraired1" type="camera">
    <always_on>true</always_on>
    <update_rate>1</update_rate>
    <visualize>false</visualize>
    <camera name="camera">
      <horizontal_fov>1.57</horizontal_fov>
      <image><width>1280</width><height>720</height><format>L_INT8</format></image>
      <clip><near>0.1</near><far>100</far></clip>
      <noise>
            <type>gaussian</type>
            <mean>0.0</mean>
            <stddev>0.05</stddev>
          </noise>
    </camera>
  </sensor>

  <!-- Infrared 2 -->
  <sensor name="cameraired2" type="camera">
    <always_on>true</always_on>
    <update_rate>1</update_rate>
    <visualize>false</visualize>
    <camera name="camera">
      <horizontal_fov>1.57</horizontal_fov>
      <image><width>1280</width><height>720</height><format>L_INT8</format></image>
      <clip><near>0.1</near><far>100</far></clip>
      <noise>
            <type>gaussian</type>
            <mean>0.0</mean>
            <stddev>0.05</stddev>
          </noise>
    </camera>
  </sensor>
  <joint name="realsense_joint" type="fixed">
      <parent>base_link</parent>
      <child>realsense_link</child>
      <pose>0.4 0 0.4 0 0 0</pose>
    </joint>

  <!-- RealSense Gazebo model plugin -->
  <plugin name="camera" filename="librealsense_gazebo_plugin.so">
      <prefix>camera</prefix>
      <depthUpdateRate>30.0</depthUpdateRate>
      <colorUpdateRate>30.0</colorUpdateRate>
      <infraredUpdateRate>1.0</infraredUpdateRate>
      <depthTopicName>aligned_depth_to_color/image_raw</depthTopicName>
      <depthCameraInfoTopicName>depth/camera_info</depthCameraInfoTopicName>
      <colorTopicName>color/image_raw</colorTopicName>
      <colorCameraInfoTopicName>color/camera_info</colorCameraInfoTopicName>
      <infrared1TopicName>infra1/image_raw</infrared1TopicName>
      <infrared1CameraInfoTopicName>infra1/camera_info</infrared1CameraInfoTopicName>
      <infrared2TopicName>infra2/image_raw</infrared2TopicName>
      <infrared2CameraInfoTopicName>infra2/camera_info</infrared2CameraInfoTopicName>
      <colorOpticalframeName>camera_color_optical_frame</colorOpticalframeName>
      <depthOpticalframeName>camera_depth_optical_frame</depthOpticalframeName>
      <infrared1OpticalframeName>camera_left_ir_optical_frame</infrared1OpticalframeName>
      <infrared2OpticalframeName>camera_right_ir_optical_frame</infrared2OpticalframeName>
      <rangeMinDepth>0.3</rangeMinDepth>
      <rangeMaxDepth>3.0</rangeMaxDepth>
      <pointCloud>true</pointCloud>
      <pointCloudTopicName>depth/color/points</pointCloudTopicName>
      <pointCloudCutoff>0.3</pointCloudCutoff>
    </plugin>
</gazebo>


<link name="l515_link">
  <visual>
    <geometry>
      <box>
        <size>0.04 0.04 0.04</size>
      </box>
    </geometry>
    <material>
      <ambient>0.2 0.2 0.2 1</ambient>
      <diffuse>0.3 0.3 0.3 1</diffuse>
    </material>
  </visual>
</link>

<gazebo reference="l515_link">
  <sensor name="realsense_l515" type="depth">
    <always_on>true</always_on>
    <update_rate>30</update_rate>
    <visualize>true</visualize>

    <camera>
      <horizontal_fov>1.047</horizontal_fov>  <!-- ~60° -->
      <image>
        <width>640</width>
        <height>480</height>
        <format>R8G8B8</format>
      </image>
      <clip>
        <near>0.05</near>
        <far>9.0</far>
      </clip>
    </camera>

    <plugin name="realsense_plugin" filename="librealsense_gazebo_plugin.so">
      <depthUpdateRate>30.0</depthUpdateRate>
      <colorUpdateRate>30.0</colorUpdateRate>
      <infraredUpdateRate>30.0</infraredUpdateRate>
      <depthTopicName>/camera/depth/image_raw</depthTopicName>
      <colorTopicName>/camera/color/image_raw</colorTopicName>
      <infrared1TopicName>/camera/ir/image_raw</infrared1TopicName>
      <infrared2TopicName>/camera/ir2/image_raw</infrared2TopicName>
      <depthCameraInfoTopicName>/camera/depth/camera_info</depthCameraInfoTopicName>
      <colorCameraInfoTopicName>/camera/color/camera_info</colorCameraInfoTopicName>
      <infrared1CameraInfoTopicName>/camera/ir/camera_info</infrared1CameraInfoTopicName>
      <infrared2CameraInfoTopicName>/camera/ir2/camera_info</infrared2CameraInfoTopicName>
    </plugin>
  </sensor>
</gazebo>

<!-- Frame tree for RS (standard optical frames) -->
<link name="camera_link"/>
<link name="camera_depth_frame"/>
<link name="camera_depth_optical_frame"/>
<link name="camera_color_frame"/>
<link name="camera_color_optical_frame"/>
<link name="camera_left_ir_frame"/>
<link name="camera_left_ir_optical_frame"/>
<link name="camera_right_ir_frame"/>
<link name="camera_right_ir_optical_frame"/>

<joint name="camera_link_joint" type="fixed">
  <parent link="realsense_link"/><child link="camera_link"/>
  <origin xyz="0 0 0" rpy="0 0 0"/>
</joint>
<joint name="camera_depth_joint" type="fixed">
  <parent link="camera_link"/><child link="camera_depth_frame"/>
  <origin xyz="0 0 0" rpy="0 0 0"/>
</joint>
<joint name="camera_depth_optical_joint" type="fixed">
  <parent link="camera_depth_frame"/><child link="camera_depth_optical_frame"/>
  <!-- optical frames: rotate -90deg about X and Z -->
  <origin xyz="0 0 0" rpy="-1.5708 0 -1.5708"/>
</joint>
<joint name="camera_color_joint" type="fixed">
  <parent link="camera_depth_frame"/><child link="camera_color_frame"/>
  <origin xyz="0 0 0" rpy="0 0 0"/>
</joint>
<joint name="camera_color_optical_joint" type="fixed">
  <parent link="camera_color_frame"/><child link="camera_color_optical_frame"/>
  <origin xyz="0 0 0" rpy="-1.5708 0 -1.5708"/>
</joint>
<joint name="camera_left_ir_joint" type="fixed">
  <parent link="camera_depth_frame"/><child link="camera_left_ir_frame"/>
  <origin xyz="0 0 0" rpy="0 0 0"/>
</joint>
<joint name="camera_left_ir_optical_joint" type="fixed">
  <parent link="camera_left_ir_frame"/><child link="camera_left_ir_optical_frame"/>
  <origin xyz="0 0 0" rpy="-1.5708 0 -1.5708"/>
</joint>
<joint name="camera_right_ir_joint" type="fixed">
  <parent link="camera_depth_frame"/><child link="camera_right_ir_frame"/>
  <origin xyz="0 -0.050 0" rpy="0 0 0"/>
</joint>
<joint name="camera_right_ir_optical_joint" type="fixed">
  <parent link="camera_right_ir_frame"/><child link="camera_right_ir_optical_frame"/>
  <origin xyz="0 0 0" rpy="-1.5708 0 -1.5708"/>
</joint>
<!-- ================== /RealSense ================== -->

  <!-- ============ Lidar sensor (2D ray) ============ -->
  <gazebo reference="lidar_link">
  <sensor name="front_laser" type="gpu_ray">
    <always_on>true</always_on>
    <update_rate>10</update_rate>
    <visualize>false</visualize>

    <ray>
      <scan>
        <horizontal>
          <samples>1024</samples>
          <resolution>1</resolution>
          <min_angle>-3.14159</min_angle>
          <max_angle> 3.14159</max_angle>
        </horizontal>
        <vertical>
          <samples>16</samples>
          <resolution>1</resolution>
          <min_angle>-0.523599</min_angle>
          <max_angle> 0.174533</max_angle>
        </vertical>
      </scan>

      <range>
        <min>0.05</min>
        <max>10.0</max>
        <resolution>0.01</resolution>
      </range>

      <noise>
        <type>gaussian</type>
        <mean>0.0</mean>
        <stddev>0.01</stddev>
      </noise>
    </ray>

    <plugin name="gazebo_ros_ray_sensor" filename="libgazebo_ros_ray_sensor.so">
      <ros>
        <namespace>/inpipe_bot</namespace>
        <remapping>~/out:=lidar/points</remapping>
        <output_type>PointCloud2</output_type>
      </ros>
      <frame_name>lidar_link</frame_name>
    </plugin>
  </sensor>
</gazebo>

  
  <gazebo reference="base_link">
  <gravity>false</gravity>
  <self_collide>false</self_collide>
</gazebo>


<!-- LEFT sonar sensor -->
<gazebo reference="sonar_left_link">
  <sensor name="sonar_left" type="ray">
    <always_on>true</always_on>
    <update_rate>15</update_rate>  <!-- slower than LiDAR -->
    <visualize>true</visualize>

    <ray>
      <scan>
        <horizontal>
          <samples>80</samples>
          <resolution>1</resolution>
          <min_angle>-0.0174533*2</min_angle>  <!-- -15° -->
          <max_angle> 0.0174533*2</max_angle>  <!-- +15° -->
        </horizontal>
        <vertical>
          <samples>50</samples>
          <resolution>1</resolution>
          <min_angle>-0.0174533*2</min_angle>  <!-- -10° -->
          <max_angle> 0.0174533*2</max_angle>  <!-- +10° -->
        </vertical>
      </scan>
      <range>
        <min>0.02</min>
        <max>10</max>         <!-- GY-US42 max range -->
        <resolution>0.01</resolution>
      </range>
      <noise>
        <type>gaussian</type>
        <mean>0.0</mean>
        <stddev>0.01</stddev>
      </noise>
    </ray>

    <plugin name="gazebo_ros_sonar" filename="libgazebo_ros_ray_sensor.so">
      <ros>
        <namespace>/inpipe_bot</namespace>
        <remapping>~/out:=sonar/left</remapping>
        <output_type>Range</output_type>
      </ros>
      <frame_name>sonar_left_link</frame_name>
    </plugin>
  </sensor>
</gazebo>



<!-- RIGHT sonar sensor -->
<gazebo reference="sonar_right_link">
  <sensor name="sonar_right" type="ray">
    <always_on>true</always_on>
    <update_rate>20</update_rate>
    <visualize>true</visualize>
    <ray>
      <scan>
        <horizontal>
          <samples>5</samples>
          <resolution>1</resolution>
          <min_angle>-0.261799</min_angle>
          <max_angle> 0.261799</max_angle>
        </horizontal>
        <vertical>
          <samples>1</samples>
          <resolution>1</resolution>
          <min_angle>0</min_angle>
          <max_angle>0</max_angle>
        </vertical>
      </scan>
      <range>
        <min>0.02</min>
        <max>3.0</max>
        <resolution>0.01</resolution>
      </range>
      <noise>
        <type>gaussian</type>
        <mean>0.0</mean>
        <stddev>0.005</stddev>
      </noise>
    </ray>

    <plugin name="gazebo_ros_sonar_right" filename="libgazebo_ros_ray_sensor.so">
      <ros>
        <namespace>/inpipe_bot</namespace>
        <remapping>~/out:=sonar/right</remapping>
        <output_type>Range</output_type>
      </ros>
      <frame_name>sonar_right_link</frame_name>
    </plugin>
  </sensor>
</gazebo>



  <!-- ============ Optional: publish Gazebo state to TF ============ -->
  <gazebo>
    <plugin name="tf_publisher" filename="libgazebo_ros_state.so">
      <ros>
        <namespace>/inpipe_bot</namespace>
      </ros>
      <publish_tf>true</publish_tf>
      <update_rate>30</update_rate>
    </plugin>
  </gazebo>

</robot>

