===============================
 FastPipeAxisEstimator Pipeline
===============================
 
Goal:
-----
Real-time detection and geometric decomposition of a pipe
(straight + elbow) from a 3D point cloud, to provide
geometry-based landmarks for SLAM and mapping.

------------------------------------------------------------
1. INPUT
------------------------------------------------------------
- ROS 2 topic: /inpipe_bot/l515/l515_depth/points
- Message type: sensor_msgs/PointCloud2
- Frame: l515_depth_optical_frame
- Transform available: base_link ← l515_depth_optical_frame

------------------------------------------------------------
2. PREPROCESSING
------------------------------------------------------------
- Convert PointCloud2 → NumPy array (x, y, z)
- Remove NaN / Inf values
- Apply voxel downsampling using Open3D
  * Typical voxel size: 0.01 – 0.02 m
  * Reduces noise and computational load

------------------------------------------------------------
3. GLOBAL AXIS ESTIMATION
------------------------------------------------------------
- Compute PCA on the downsampled points
  → First principal component = approximate pipe axis
- Project all points onto this axis
  → Gives 1-D coordinate "s" (distance along pipe)

------------------------------------------------------------
4. CENTERLINE BINNING
------------------------------------------------------------
- Divide the projected axis "s" into equal bins (60–120)
- For each bin:
  * Compute mean (x, y, z) of contained points
  * Store as a "centerline" point
- Optionally smooth the centerline using a moving average

------------------------------------------------------------
5. CURVATURE & ELBOW DETECTION
------------------------------------------------------------
- Compute local tangents along the centerline
- Compute curvature as the angle between consecutive tangents
- Weight curvature by segment length to suppress noise
- Find maximum weighted curvature → elbow location
- Define a small band around this bin as the "elbow region"

------------------------------------------------------------
6. SEGMENT CLASSIFICATION
------------------------------------------------------------
- Assign bins:
  * Before elbow band  → Straight 1
  * Inside elbow band → Elbow
  * After elbow band  → Straight 2
- Evaluate each side:
  * If side has few points or high curvature → merge into elbow
  * This allows detection of only one straight + elbow

------------------------------------------------------------
7. GEOMETRIC ESTIMATION
------------------------------------------------------------
For each valid straight segment:
  - Apply PCA to obtain its local axis direction and centroid
  - Compute median distance from points to axis → radius
  - Calculate yaw and pitch of axis in base_link frame

Compute:
  - Pipe radius (average of straight sections)
  - Elbow angle (angle between two straight axes)

------------------------------------------------------------
8. OUTPUT
------------------------------------------------------------
Published topics:
  - /pipe/straight1 : PointCloud2 (first straight)
  - /pipe/straight2 : PointCloud2 (second straight, if exists)
  - /pipe/elbow     : PointCloud2 (elbow region)

Console logs:
  - Estimated radius
  - Elbow angle (deg)
  - Axis directions (yaw, pitch)
  - Real-time runtime per frame

------------------------------------------------------------
9. USE IN SLAM PIPELINE
------------------------------------------------------------
- Straight axis → provides orientation constraint
- Elbow center → geometric landmark for loop closure
- Outputs can be fused with odometry / ICP pose estimates
- Enables geometry-aware SLAM inside pipeline environments

------------------------------------------------------------
10. PERFORMANCE
------------------------------------------------------------
- Runtime: 5–15 ms (CPU)
- Accuracy:
  * Radius ±3–5 mm
  * Elbow angle ±5–8°
- Supports variable elbow angles (30°–120°)
- Works with pipes of varying radii (no retraining)
- No dependence on normals or learning

------------------------------------------------------------
END OF PIPELINE DESCRIPTION
------------------------------------------------------------







=====================================================================
 COMPARISON OF REAL-TIME PIPE + ELBOW DETECTION METHODS FOR SLAM
=====================================================================

| Method | Input Requirements | Outputs | Runtime (CPU) | Accuracy (Radius / Angle) | Handles Different Elbow Angles | Handles Variable Radius | Robustness | Integration with SLAM | Pros | Cons | Best Use Case |
|---------|--------------------|----------|----------------|---------------------------|--------------------------------|-------------------------|-------------|------------------------|------|------|----------------|

1. Centerline + Curvature (Slice/Kink Detection)
   - Input: PointCloud2 (XYZ only)
   - Outputs: Centerline, elbow position, straight axis
   - Runtime: 5–15 ms
   - Accuracy: Radius ±3 mm, Angle ±5–8°
   - Angles: Good (works for any bend)
   - Radius: Good
   - Robustness: Medium (needs clean centerline)
   - Integration: Very easy (lightweight, no dependencies)
   - Pros: Simple, fast, robust
   - Cons: Sensitive to sparse points; elbow width tuning
   - Best for: Real-time pre-filtering or pipe-following SLAM

2. RANSAC Cylinder Fit (PCL)
   - Input: XYZ + normals
   - Outputs: Axis, radius, elbow angle (via two fits)
   - Runtime: 20–50 ms
   - Accuracy: Radius ±1–2 mm, Angle ±2–4°
   - Angles: Excellent
   - Radius: Excellent
   - Robustness: High (rejects outliers)
   - Integration: Easy (built into ROS PCL)
   - Pros: Accurate geometry, stable axis
   - Cons: Needs normals; may split long straights
   - Best for: Precise geometry in SLAM or calibration

3. Region Growing + Cylinder Fit
   - Input: XYZ + normals
   - Outputs: Segmented surfaces + fitted cylinders
   - Runtime: 40–80 ms
   - Accuracy: Radius ±2 mm, Angle ±3–5°
   - Angles: Excellent
   - Radius: Excellent
   - Robustness: High
   - Integration: Medium
   - Pros: Smooth segmentation, robust on joints
   - Cons: Slower; parameter tuning required
   - Best for: Pipes with rough or corroded surfaces

4. Cylindrical Hough Transform
   - Input: Dense XYZ
   - Outputs: Cylinder axes and radii
   - Runtime: >100 ms
   - Accuracy: Radius ±3 mm
   - Angles: Good
   - Radius: Good
   - Robustness: Medium
   - Integration: Heavy computation
   - Pros: Detects multiple pipes automatically
   - Cons: Very slow for real-time
   - Best for: Offline validation or geometry fitting

5. Skeletonization / Medial Axis
   - Input: Voxelized XYZ
   - Outputs: Centerline + curvature
   - Runtime: 30–60 ms
   - Accuracy: Angle ±5–7°
   - Angles: Good
   - Radius: Moderate (depends on voxel size)
   - Robustness: Medium
   - Integration: Moderate (topology graph)
   - Pros: Clean topology, good for junctions
   - Cons: Memory heavy; slower
   - Best for: Topology-aware SLAM or map building

6. Template / ICP Matching
   - Input: XYZ or RGB-D
   - Outputs: Template pose (straight / elbow)
   - Runtime: 50–120 ms (GPU)
   - Accuracy: Angle ±1–3°
   - Angles: Medium (needs one model per elbow)
   - Radius: Medium (template radius)
   - Robustness: Medium
   - Integration: Moderate
   - Pros: Very accurate if models known
   - Cons: Needs initialization; occlusion sensitive
   - Best for: Known pipe designs (45°, 90° elbows)

7. Supervoxel Graph Segmentation
   - Input: XYZ (+ color optional)
   - Outputs: Surface clusters, elbow boundary
   - Runtime: 60–100 ms
   - Accuracy: Angle ±4–6°
   - Angles: Good
   - Radius: Good
   - Robustness: High
   - Integration: Medium
   - Pros: Spatially consistent segmentation
   - Cons: Parameter tuning; slower
   - Best for: Multi-pipe or branched pipe networks

8. Deep Learning (PointNet++, KPConv, RandLA-Net)
   - Input: Labeled 3D point cloud
   - Outputs: Per-point classes (Straight / Elbow / Wall)
   - Runtime: 20–40 ms (GPU)
   - Accuracy: Radius ±2 mm, Angle ±2–3°
   - Angles: Excellent
   - Radius: Excellent
   - Robustness: Very High
   - Integration: Medium (ROS2 or PyTorch bridge)
   - Pros: Handles noise and variable geometry
   - Cons: Requires labeled data; GPU required
   - Best for: Real-world inspection SLAM with complex geometry

=====================================================================
 SUMMARY BY APPLICATION
=====================================================================

Goal: Real-time pre-processing before SLAM
 → Recommended: Centerline + Curvature
 → Reason: 5–15 ms, CPU-only, gives elbow pose for map alignment

Goal: Highest geometric precision
 → Recommended: RANSAC Cylinder Fit
 → Reason: Best radius and axis accuracy for geometric constraints

Goal: Robustness in rough or corroded pipes
 → Recommended: Region Growing + Cylinder Fit
 → Reason: Smooths over noise, more stable elbow detection

Goal: Adaptive to arbitrary geometry
 → Recommended: Deep Learning (PointNet++ / RandLA-Net)
 → Reason: Learns variable radii and elbows, works on GPU

Goal: Mapping complex networks or junctions
 → Recommended: Skeletonization or Supervoxel Graph
 → Reason: Captures full pipe topology for SLAM graph nodes

=====================================================================
 SUGGESTED HYBRID PIPELINE FOR REAL-TIME SLAM
=====================================================================

Stage 1: Centerline + Curvature (fast CPU preprocessing)
Stage 2: RANSAC Cylinder Fit (refine geometry at lower rate)
Stage 3: Use axes + elbow centers as SLAM landmarks
Stage 4: (Optional) Deep model for semantic refinement (GPU/offline)
=====================================================================

